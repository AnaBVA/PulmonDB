---
title: "Study_case"
output: html_document
---

```{r pressure, echo=FALSE}
library(tidyverse)
library(dplyr)
library(ggrepel)
library(plotly)
library(ggpubr)
library(limma)
library(PulmonDB)
library(magrittr)
library(ggfortify)
library(gridExtra)
library(Rtsne)
library(glue)

#setwd("~/Documents/Doctorado/COPD_analysis")
############# local functions

select_by <- function(data, condition = "Tissue"){
  if (condition == "Tissue"){
    data %>%
    group_by(contrast_name) %>%
    filter(condition_node_name == "LUNG_BIOPSY") %>%
    distinct("contrast_name",.keep_all = TRUE) %>%
    select(1,2)
  }
  else if (condition == "Disease") {
    data %>%
    group_by(contrast_name) %>%
    filter(parent_node_id == 87 )  %>%
    distinct("contrast_name",.keep_all = TRUE) %>%
    select(1,2)
  }
}

m <- function(x= "PC1", y = PC2, leg = 'none'){
  Y <- enquo(y)
  Y <- quo(!! Y)
  return( glue("{Y[2]}"))
}

m <- function(x= "PC1", y = PC2, leg = 'none'){
  Y <- enquo(y)
  Y <- get_expr(Y)
  return( Y)
}


my_plot <- function(df,x=PC1, y =PC2, leg = 'none'){
  x <- enquo(x)
  y <- enquo(y)
  X <- get_expr(x)
  Y <- get_expr(y)
  if (str_detect(X,"PC")){
    title.txt <- glue("PCA of {X} versus {Y}")
  }
  else if (str_detect(X,"X")){
    title.txt <- glue("tSNE of {X} versus {Y}")
  }
  ggplot(data = df, aes(x= !! x,
                        y= !! y,
                        colour= test2
                       ),
                  frame = TRUE,
                  frame.type = 'norm') +
  scale_color_manual(values = c("#930404", "#3f7ac6","#0dba79")) +
  scale_shape_manual(values=seq(1:length(unique(df$experiment_access_id)))) +
  geom_point(aes(shape=experiment_access_id,
                 stroke = 1.5
                 ),
             colour = "black",
             size = 4
             ) +
  geom_point(alpha=0.8, size = 4) +
  labs(title = title.txt) +
  theme(legend.position = leg,
        text = element_text(size = 20),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "#292929")
        )
}


# internet
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
  }

############# Files
norm_data <- read_csv("~/Documents/Doctorado/COPD_analysis/data/April_2019/2_pivotdata.txt")
norm_data[,-which(colSums(is.na(norm_data)) == nrow(norm_data))]  # Remove columns with all NA

gse <- read_tsv("~/Documents/Doctorado/COPD_analysis/data/April_2019/gse_gpl.txt")

c.anno <- read_tsv("~/Documents/Doctorado/COPD_analysis/data/April_2019/contrast_conditions.txt") %>%
  group_by(contrast_name)

r.anno <- read_tsv("~/Documents/Doctorado/COPD_analysis/data/April_2019/ref_conditions.txt") %>%
  group_by(contrast_name)



############# Select disease information
c.disease <- select_by(c.anno,"Disease")
r.disease <- select_by(r.anno, "Disease")

## Select tissue
r.tissue <- select_by(r.anno, "Tissue")
r.disease <- filter(r.disease, contrast_name %in% r.tissue$contrast_name)


############# Merge data
pheno <- right_join(c.disease,r.disease, by = "contrast_name") %>%
  set_colnames(c("contrast_name","test","ref")) %>% 
  mutate(test = coalesce(test,ref))

############# Select Disease
CH.H <- pheno %>%
  filter(ref == "HEALTHY/CONTROL") %>% #| ref == "MATCH_TISSUE_CONTROL") %>%
  filter(test=="COPD"| test=="AAD"| test=="EMPHYSEMA" | test=="HEALTHY/CONTROL"| test == "MATCH_TISSUE_CONTROL" | test == "IPF") %>%
  mutate(
    test2 = str_replace(test,"AAD|EMPHYSEMA","COPD"),
    ref2 = str_replace(ref,"HEALTHY/CONTROL|MATCH_TISSUE_CONTROL","CONTROL")
  )

ref_anno <- r.anno %>%
  select(-parent_node_id) %>%
  spread(condition_node_name, 2) %>%
  filter(contrast_name %in% CH.H$contrast_name)

c_anno <- c.anno %>%
  select(-parent_node_id) %>%
  spread(condition_node_name, delta_value) %>%
  filter(contrast_name %in% CH.H$contrast_name)

# plot histograms

c_anno$AGE_PER_INDIVIDUAL <- as.numeric(c_anno$AGE_PER_INDIVIDUAL)
c_anno$PACK_PER_YEAR <- as.numeric((c_anno$PACK_PER_YEAR))

ggplot(c_anno, aes(x=AGE_PER_INDIVIDUAL)) + geom_histogram(na.rm = FALSE)
ggplot(c_anno, aes(x=PACK_PER_YEAR)) + geom_histogram(na.rm = FALSE)


n_data <- norm_data %>%
  select(c("gene_name",pull(CH.H,contrast_name)))

#quitar contrastes que tienen datos faltantes en en mas de 3/4 de los datos
s <- summary(colSums(is.na(n_data)))
Data <- n_data[,colSums(is.na(n_data)) <= s["3rd Qu."]]
Data <- n_data
#Data <- Data  %>%
  filter(gene_name %in% #c("CXCL12","CD83","IGFBP2","OLR1","IGF1","BMP2","IGFBP5","SPOCK2","VEGFC","IL1A","JUND","FUT1","VEGFA","IL6R"))
 # filter(gene_name %in% rownames(red_genesDE))


# Keep genes without NAs in all contrast
Data <- Data[rowSums(is.na(Data)) == 0,] # A tibble: 13,627 x 164


anno_tissue <- gse %>%
  filter(contrast_name %in% colnames(Data)) %>%
  right_join(CH.H, by = "contrast_name")

anno_tissue$test2 <- factor(anno_tissue$test2)
anno_tissue$ref2 <- factor(anno_tissue$ref2)

###########################
###PCA
e <- prcomp(t(Data[,-1]))
rownames(e$x) <- colnames(Data)[-1]
rownames(e$rotation) <- Data$gene_name

df <- merge(e$x[,1:3], anno_tissue, by.x= 0, by.y=1, all.x=TRUE)

# https://rpubs.com/Cristina_Gil/PCA
var <- get_pca_var(e)
var_exp <- fviz_screeplot(e,addlabels = TRUE, ylim = c(0,35), barfill = "#6b0778", barcolor ="white") +
  labs(title = "Variances in PCA components",x = "Principal Components", y = "Variance (%)") +
  theme(text = element_text(size = 18),
        axis.text.x= element_text(margin = margin(3,1,1,1)),
        plot.margin = unit(c(3,1,1,1),"lines"),
                panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
        )

contri_var <- fviz_contrib(e,choice = "var", axes = 1, top = 20,  fill = "#076b78", color ="white") +
  labs(title = "Contribution of variables in PC1") +
  #theme_minimal(18) +
  theme(text = element_text(size = 18),
        axis.text.x= element_text(angle=45, 
                                  margin = margin(1,1,1,1)),
        plot.margin = unit(c(3,1,0.5,1),"lines"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
        )

############### TSNE
#install.packages('Rtsne')

tsne <- Rtsne(as.matrix(t(Data[,-1])), dims = 3, check_duplicates = FALSE)
tsne_data <- data.frame(tsne$Y)
rownames(tsne_data) <- colnames(Data)[-1]
tsne_data <- merge(tsne_data,df,by.x = 0, by.y = 1, all.x = TRUE)

############### 
#autoplot(e, data = df, colour = "test2")
#p3 <- plot_ly(df, x = ~PC2, y = ~PC3, color = ~test2)

tpca_12 <- my_plot(df,PC1,PC2)
tpca_23 <- my_plot(df,PC2,PC3)
ttsne <- my_plot(tsne_data,X1,X2)

legend <- g_legend(my_plot(df,PC1,PC2,"right"))


# pdf 20 x 10 
# pdf 12 x 12
 grid.arrange(tpca_12,
             ttsne,
             tpca_23,
             legend,
             var_exp,
             contri_var,
             heights = c(2.7,2.7,2),
             layout_matrix = rbind(c(1,2),
                                   c(3,4),
                                   c(5,6))
             )

              #layout_matrix = rbind(c(1,1,2,2,3,3),
               #                    c(4,4,4,5,5,5))

###########################
anno_tissue$test2 <-  as.factor(gsub("HEALTHY/CONTROL","CONTROL",anno_tissue$test2))
 
#designS <- model.matrix(~0 +d + experiment_access_id,gsetm)
designDE <- model.matrix(~0 + test2 + experiment_access_id ,anno_tissue)

### data
D <- data.frame(Data)
rownames(D) <- D[,1]
D <- D[-1]
colnames(D) <-  gsub(".vs.","-vs-",colnames(D))

# Model
fitDE <- lmFit(as.matrix(D),designDE)
#fitDE <- lmFit(assay(g),designDE)


cont.matrixDE <- makeContrasts(COPDvsIPF=test2COPD-test2IPF,
                               COPDvsH =test2COPD-test2CONTROL,
                               IPFvsH = test2IPF-test2CONTROL,
                               COPDandIPFvsH = (test2COPD + test2IPF)/2 -test2CONTROL,
                               levels = designDE)

#cont.matrixDE <- makeContrasts(P3=testCOPD-testIPF,
                              # levels = designDE)
fit2DE <- contrasts.fit(fitDE,cont.matrixDE)
fit3DE <- eBayes(fit2DE)
dtDE <- decideTests(fit3DE)
summary(dtDE)

genesCOPDvsH <- topTable(fit3DE,coef=2,n = Inf, adjust="fdr", p = 0.005, sort.by = "B")
genesIPFvsH <- topTable(fit3DE,coef=3,n = Inf, adjust="fdr", p = 0.005, sort.by = "B")

genesSIMILAR <-  topTable(fit3DE,coef=4,n = 20, adjust="fdr", p = 0.005, sort.by = "logFC")
genesSIMILAR_p <-  topTable(fit3DE,coef=4, n = Inf,adjust="fdr", p = 0.005, sort.by = "logFC")
genesSIMILAR_all <- topTable(fit3DE,coef=4,n = Inf, adjust="fdr", sort.by = "logFC")


genesCOPDvsIPF <- topTable(fit3DE,coef=1,n = 20, adjust="fdr", p = 0.005, sort.by = "logFC")
genesCOPDvsIPF_p <- topTable(fit3DE,coef=1,n = Inf, adjust="fdr", p = 0.005, sort.by = "logFC")
genesCOPDvsIPF_all <- topTable(fit3DE,coef=1,n = Inf, adjust="fdr", sort.by = "logFC")



#write.csv(genesCOPDvsIPF,"data_output/DE_COPDvsIPF_v2.txt", quote = FALSE)
#write.csv(genesSIMILAR,"data_output/DE_SIMILAR_v2.txt", quote = FALSE)

#write.csv(genesCOPDvsIPF_p,"data_output/DE_COPDvsIPF_all_v2.txt", quote = FALSE)
#write.csv(genesSIMILAR_p,"data_output/DE_SIMILAR_all_v2.txt", quote = FALSE)

paste(rownames(genesCOPDvsIPF),collapse = ",")
paste(rownames(genesSIMILAR),collapse = ",")


## es el fit3 de COPDvsIPf y el de fit3 de SIMMILAR


dt <- cbind(decideTests(fit3DE[,"COPDvsIPF"]),decideTests(fit3DE[,"COPDandIPFvsH"]))
ds <- cbind(decideTests(fit3DE[,"COPDvsH"]),decideTests(fit3DE[,"IPFvsH"]))


colnames(dt) <- c("Similar genes", "DE genes")

pdf("fig_output/VennSimilarDE.pdf")
vennDiagram(dt, circle.col=c("#09b7a2", "#096cb7"))
dev.off()

summary(decideTests(fit3DE))

###Volcano limma plot

#SIMILAR
red_genesS <- topTable(fit3DE,coef=4,n = Inf, adjust="fdr", p = 0.005, sort.by = "logFC")

gS <-  ggplot(data=genesSIMILAR_all, aes(x=logFC, y=-log10(adj.P.Val))) + 
  geom_point(alpha=0.7, size=1.75) +
  xlab("log(Fold-Change)") + 
  ylab("-log10 FDR(p-value)") +
  ggtitle("Similar genes between COPD and IPF") +
  geom_point(color=ifelse(rownames(genesSIMILAR_all) %in% rownames(red_genesS), "red","black")) +
  #geom_vline(xintercept=1, linetype="dashed", color = "red") +
  #geom_vline(xintercept = -1, linetype="dashed", color = "red") +
  geom_hline(yintercept = -log10(0.005), linetype="dashed", color = "red") +
  geom_text_repel(data = genesSIMILAR, 
                  aes(genesSIMILAR$logFC, -log10(genesSIMILAR$adj.P.Val), label = rownames(genesSIMILAR)),
                  check_overlap = TRUE,
                  size = 3,
                  position = position_dodge(0.9)
  ) +
  theme_bw(24)

#DE
red_genesDE <- topTable(fit3DE,coef=1,n = Inf, adjust="fdr", p = 0.005, sort.by = "logFC")

gDE <-  ggplot(data=genesCOPDvsIPF_all, aes(x=logFC, y=-log10(adj.P.Val))) + 
  geom_point(alpha=0.7, size=1.75) +
  xlab("log(Fold-Change)") + 
  ylab("-log10 FDR(p-value)") +
  ggtitle("DE genes between COPD and IPF") +
  geom_point(color=ifelse(rownames(genesCOPDvsIPF_all) %in% rownames(red_genesDE), "red","black")) +
  #geom_vline(xintercept=1, linetype="dashed", color = "red") +
  #geom_vline(xintercept = -1, linetype="dashed", color = "red") +
  geom_hline(yintercept = -log10(0.005), linetype="dashed", color = "red") +
  geom_text_repel(data = genesCOPDvsIPF, 
                  aes(genesCOPDvsIPF$logFC, -log10(genesCOPDvsIPF$adj.P.Val), label = rownames(genesCOPDvsIPF)),
                  check_overlap = TRUE,
                  size = 3,
                  position = position_dodge(0.9)
  ) +
  theme_bw(24)



### Put together the volcano plots 
#pdf("fig_output/volcano_plots.pdf",height = 8, width = 18 )
ggarrange(gDE,gS,
          ncol = 2,
          nrow = 1,
          align = "hv"
)
#dev.off()




##############################################

gses <- c("GSE52463","GSE63073","GSE1122","GSE72073","GSE24206","GSE27597","GSE29133","GSE31934","GSE37768")


g1 <- genesPulmonDB("all",gses[1])
g2 <- genesPulmonDB("all",gses[2])
g3 <- genesPulmonDB("all",gses[3])
g4 <- genesPulmonDB("all",gses[4])
g5 <- genesPulmonDB("all",gses[5]) 
g6 <- genesPulmonDB("all",gses[6]) # some fibroblast
g7 <- genesPulmonDB("all",gses[7]) # alveolar
g8 <- genesPulmonDB("all",gses[8])
g9 <- genesPulmonDB("all",gses[9])

g_data <- genesPulmonDB("all",gses)

# Remove alveolar cells
# colData(g_data)[colData(g_data)[,3] == levels(colData(g_data)[,3])[1],]

# Tissue samples
g <- g_data[,g_data$SAMPLE_TYPE==levels(colData(g_data)[,3])[3]]




```




